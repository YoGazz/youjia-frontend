# 🚀 TestPro 后端接入指南

## 📚 目录
1. [基础概念](#基础概念)
2. [当前项目状态](#当前项目状态)
3. [接入步骤](#接入步骤)
4. [配置修改](#配置修改)
5. [API接口对接](#api接口对接)
6. [错误处理](#错误处理)
7. [测试验证](#测试验证)
8. [常见问题](#常见问题)

## 🧠 基础概念

### 什么是API接口？
API（Application Programming Interface）是前端和后端之间的"桥梁"：

```
前端页面 ←→ API接口 ←→ 后端服务器 ←→ 数据库
   ↓           ↓           ↓           ↓
用户操作    HTTP请求    业务逻辑    数据存储
```

### HTTP请求方法
- **GET**: 获取数据（查询）
- **POST**: 创建数据（新增）
- **PUT**: 更新数据（修改）
- **DELETE**: 删除数据
- **PATCH**: 部分更新数据

### 请求和响应格式
```javascript
// 请求示例
POST /api/auth/login
Content-Type: application/json
{
  "username": "admin",
  "password": "123456"
}

// 响应示例
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com"
    }
  }
}
```

## 📋 当前项目状态

### 现有配置
项目已经配置好了基础的API结构：

1. **API配置文件**: `src/api/request.ts` - HTTP客户端配置
2. **接口定义**: `src/api/index.ts` - 具体的API接口
3. **类型定义**: `src/types/api.ts` - TypeScript类型
4. **模拟后端**: `mock/server.js` - 开发用的假数据

### 当前使用的是模拟数据
- 前端请求 → Vite代理 → 模拟后端 → 返回假数据
- 模拟后端地址：http://localhost:8081

## 🎯 接入步骤

### 步骤1：获取后端信息

首先，您需要从后端开发者那里获取以下信息：

#### 必需信息
- **后端服务器地址**: 如 `https://api.testpro.com` 或 `http://192.168.1.100:8080`
- **API文档**: 接口地址、参数格式、响应格式
- **认证方式**: Token、API Key等
- **环境信息**: 开发环境、测试环境、生产环境地址

#### API文档示例
```
基础地址: https://api.testpro.com
认证方式: Bearer Token

接口列表:
POST /api/auth/login     - 用户登录
POST /api/auth/register  - 用户注册
GET  /api/users         - 获取用户列表
POST /api/users         - 创建用户
PUT  /api/users/:id     - 更新用户
DELETE /api/users/:id   - 删除用户
```

### 步骤2：修改API配置

#### 2.1 修改基础URL
编辑 `src/api/request.ts` 文件：

```typescript
// 当前配置（使用代理）
const api: AxiosInstance = axios.create({
  baseURL: '/api', // 代理到模拟后端
  timeout: 10000,
})

// 修改为真实后端地址
const api: AxiosInstance = axios.create({
  baseURL: 'https://api.testpro.com', // 真实后端地址
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})
```

#### 2.2 环境变量配置（推荐）
创建环境变量文件来管理不同环境的配置：

**创建 `.env.development` 文件**：
```
# 开发环境
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=TestPro开发环境
```

**创建 `.env.production` 文件**：
```
# 生产环境
VITE_API_BASE_URL=https://api.testpro.com/api
VITE_APP_TITLE=TestPro
```

**修改 `src/api/request.ts`**：
```typescript
const api: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})
```

### 步骤3：对接具体接口

#### 3.1 确认接口格式
与后端开发者确认每个接口的具体格式：

```typescript
// 示例：登录接口对接
// 后端文档说明：
// POST /api/auth/login
// 请求参数: { username: string, password: string }
// 响应格式: { code: number, message: string, data: { token: string, user: object } }

export const authApi = {
  login: (data: LoginRequest): Promise<ApiResponse<LoginResponse>> => {
    return api.post('/auth/login', data)
  }
}
```

#### 3.2 调整类型定义
根据后端实际返回的数据格式，修改 `src/types/api.ts`：

```typescript
// 根据后端实际响应格式调整
export interface ApiResponse<T = any> {
  code: number        // 后端返回的状态码
  message: string     // 后端返回的消息
  data: T            // 实际数据
  timestamp?: string  // 时间戳（如果后端有）
}

export interface LoginResponse {
  token: string
  user: User
  expiresIn?: number  // token过期时间（如果后端有）
}
```

### 步骤4：处理跨域问题

#### 4.1 开发环境（使用代理）
如果后端不支持跨域，在开发环境可以使用Vite代理。

修改 `vite.config.ts`：
```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080', // 后端地址
        changeOrigin: true,
        secure: false,
        // rewrite: (path) => path.replace(/^\/api/, '') // 如果需要去掉/api前缀
      }
    }
  }
})
```

#### 4.2 生产环境
生产环境需要后端配置CORS，或者使用Nginx等反向代理。

### 步骤5：更新认证逻辑

#### 5.1 Token处理
确认后端的Token格式和使用方式：

```typescript
// 在 request.ts 的请求拦截器中
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token')
  if (token) {
    // 确认后端需要的Token格式
    config.headers.Authorization = `Bearer ${token}` // 或者其他格式
  }
  return config
})
```

#### 5.2 错误处理
根据后端的错误码调整错误处理逻辑：

```typescript
// 在 request.ts 的响应拦截器中
api.interceptors.response.use(
  (response) => {
    // 根据后端的成功标识判断
    if (response.data.code === 200) {
      return response.data
    } else {
      // 处理业务错误
      return Promise.reject(new Error(response.data.message))
    }
  },
  (error) => {
    // 处理HTTP错误
    if (error.response?.status === 401) {
      // Token过期，跳转登录
      localStorage.removeItem('token')
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

## 🔧 实际操作示例

### 示例1：对接登录接口

#### 后端接口文档
```
POST /api/auth/login
请求参数:
{
  "username": "string",
  "password": "string"
}

响应格式:
{
  "success": true,
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": "admin"
    }
  }
}
```

#### 前端代码调整

**1. 更新类型定义 (`src/types/api.ts`)**：
```typescript
export interface ApiResponse<T = any> {
  success: boolean
  code: number
  message: string
  data: T
}

export interface LoginResponse {
  accessToken: string  // 注意：后端返回的是accessToken，不是token
  user: User
}
```

**2. 更新API接口 (`src/api/index.ts`)**：
```typescript
export const authApi = {
  login: (data: LoginRequest): Promise<ApiResponse<LoginResponse>> => {
    return api.post('/auth/login', data)
  }
}
```

**3. 更新登录逻辑 (`src/stores/auth.ts`)**：
```typescript
const login = async (loginData: LoginRequest) => {
  try {
    isLoading.value = true
    const response = await authApi.login(loginData)
    
    // 根据后端实际返回的字段名调整
    const { accessToken, user } = response.data
    
    // 保存token（注意字段名）
    localStorage.setItem('token', accessToken)
    localStorage.setItem('user', JSON.stringify(user))
    
    // 更新状态
    token.value = accessToken
    currentUser.value = user
    
    return response
  } catch (error) {
    console.error('登录失败:', error)
    throw error
  } finally {
    isLoading.value = false
  }
}
```

**4. 更新请求拦截器 (`src/api/request.ts`)**：
```typescript
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token')
  if (token) {
    // 确认后端需要的Token格式
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

### 示例2：对接用户列表接口

#### 后端接口文档
```
GET /api/users?page=1&size=10&keyword=admin
响应格式:
{
  "success": true,
  "code": 200,
  "data": {
    "list": [...],
    "total": 100,
    "page": 1,
    "size": 10
  }
}
```

#### 前端代码调整

**1. 更新类型定义**：
```typescript
export interface PageResponse<T> {
  list: T[]      // 注意：后端返回的是list，不是items
  total: number
  page: number
  size: number
}
```

**2. 更新API接口**：
```typescript
export const userApi = {
  getAllUsers: (params?: {
    page?: number
    size?: number
    keyword?: string
  }): Promise<ApiResponse<PageResponse<User>>> => {
    return api.get('/users', { params })
  }
}
```

**3. 在组件中使用**：
```typescript
// 在 UserManagement.vue 中
const fetchUsers = async () => {
  try {
    loading.value = true
    const response = await userApi.getAllUsers({
      page: currentPage.value,
      size: pageSize.value,
      keyword: searchKeyword.value
    })
    
    // 根据后端实际返回的数据结构调整
    const { list, total } = response.data
    users.value = list
    totalUsers.value = total
    
  } catch (error) {
    ElMessage.error('获取用户列表失败')
  } finally {
    loading.value = false
  }
}
```

## 🐛 常见问题和解决方案

### 问题1：跨域错误
```
Access to XMLHttpRequest at 'https://api.testpro.com/api/auth/login' 
from origin 'http://localhost:3000' has been blocked by CORS policy
```

**解决方案**：
1. **开发环境**：使用Vite代理
2. **生产环境**：让后端配置CORS
3. **临时方案**：使用浏览器插件禁用CORS（仅开发时）

### 问题2：Token格式错误
```
401 Unauthorized: Invalid token format
```

**解决方案**：
确认后端需要的Token格式：
- `Bearer ${token}`
- `Token ${token}`
- 直接传递token值

### 问题3：数据格式不匹配
```
TypeError: Cannot read property 'data' of undefined
```

**解决方案**：
1. 检查后端实际返回的数据结构
2. 更新TypeScript类型定义
3. 调整前端代码中的数据访问方式

### 问题4：网络请求超时
```
timeout of 10000ms exceeded
```

**解决方案**：
1. 增加超时时间
2. 检查网络连接
3. 确认后端服务是否正常

## ✅ 测试验证

### 1. 使用浏览器开发者工具
1. 打开F12开发者工具
2. 切换到Network标签
3. 执行登录操作
4. 查看请求和响应

### 2. 使用Postman测试
在对接前端之前，先用Postman测试后端接口：
```
POST https://api.testpro.com/api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "123456"
}
```

### 3. 逐步测试
1. 先测试登录接口
2. 再测试需要认证的接口
3. 最后测试完整的业务流程

## 📝 检查清单

接入后端前，请确认以下事项：

- [ ] 获得后端API文档
- [ ] 确认后端服务器地址
- [ ] 了解认证方式和Token格式
- [ ] 确认数据格式和字段名
- [ ] 配置开发环境代理（如需要）
- [ ] 更新API基础URL
- [ ] 调整类型定义
- [ ] 更新错误处理逻辑
- [ ] 测试登录功能
- [ ] 测试其他接口
- [ ] 处理跨域问题

## 🎯 下一步

接入后端后，您可能还需要：

1. **优化错误处理**：统一错误提示和处理
2. **添加加载状态**：提升用户体验
3. **实现数据缓存**：减少不必要的请求
4. **添加请求重试**：提高稳定性
5. **监控和日志**：便于问题排查

---

**💡 提示：接入后端是一个逐步的过程，建议先从登录接口开始，确保基础功能正常后再逐步对接其他接口。**
