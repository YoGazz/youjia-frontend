# 🔧 环境配置示例

## 📋 快速配置指南

### 方式一：直接修改API地址（简单快速）

#### 1. 修改 `src/api/request.ts`

```typescript
// 找到这一行
const api: AxiosInstance = axios.create({
  baseURL: '/api', // 当前使用代理到模拟后端
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 修改为
const api: AxiosInstance = axios.create({
  baseURL: 'https://your-backend-api.com/api', // 替换为真实后端地址
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})
```

#### 2. 注释掉Vite代理配置

修改 `vite.config.ts`：
```typescript
export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    port: 3000,
    host: '0.0.0.0',
    // 注释掉代理配置，直接访问真实后端
    // proxy: {
    //   '/api': {
    //     target: 'http://localhost:8081',
    //     changeOrigin: true,
    //     secure: false,
    //     ws: true
    //   }
    // }
  }
})
```

### 方式二：使用环境变量（推荐）

#### 1. 创建环境变量文件

**创建 `.env.development`**（开发环境）：
```env
# 开发环境配置
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=TestPro开发环境
VITE_APP_ENV=development
```

**创建 `.env.production`**（生产环境）：
```env
# 生产环境配置
VITE_API_BASE_URL=https://api.testpro.com/api
VITE_APP_TITLE=TestPro
VITE_APP_ENV=production
```

**创建 `.env.test`**（测试环境）：
```env
# 测试环境配置
VITE_API_BASE_URL=https://test-api.testpro.com/api
VITE_APP_TITLE=TestPro测试环境
VITE_APP_ENV=test
```

#### 2. 修改 `src/api/request.ts`

```typescript
import axios, { type AxiosInstance, type AxiosResponse } from 'axios'
import type { ApiResponse } from '@/types/api'

// 根据环境变量决定API地址
const getBaseURL = () => {
  // 如果有环境变量，使用环境变量
  if (import.meta.env.VITE_API_BASE_URL) {
    return import.meta.env.VITE_API_BASE_URL
  }
  
  // 否则根据环境判断
  if (import.meta.env.DEV) {
    // 开发环境，使用代理
    return '/api'
  } else {
    // 生产环境，使用真实地址
    return 'https://api.testpro.com/api'
  }
}

const api: AxiosInstance = axios.create({
  baseURL: getBaseURL(),
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
api.interceptors.request.use(
  (config) => {
    // 开发环境显示请求日志
    if (import.meta.env.DEV) {
      console.log('🚀 发送请求:', {
        url: config.url,
        method: config.method,
        baseURL: config.baseURL,
        data: config.data
      })
    }
    
    // 添加认证token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
api.interceptors.response.use(
  (response: AxiosResponse<ApiResponse>) => {
    // 开发环境显示响应日志
    if (import.meta.env.DEV) {
      console.log('✅ 收到响应:', {
        status: response.status,
        data: response.data,
        url: response.config.url
      })
    }
    
    // 根据后端的响应格式调整
    // 如果后端返回格式是 { code: 200, data: {...}, message: "success" }
    if (response.data.code === 200) {
      return response.data
    } else {
      // 业务错误
      return Promise.reject(new Error(response.data.message || '请求失败'))
    }
  },
  (error) => {
    // 开发环境显示错误日志
    if (import.meta.env.DEV) {
      console.error('❌ 请求错误:', error)
    }
    
    if (error.response) {
      const { status, data } = error.response
      
      switch (status) {
        case 401:
          // Token过期或无效
          localStorage.removeItem('token')
          localStorage.removeItem('user')
          window.location.href = '/login'
          break
        case 403:
          console.error('没有权限访问该资源')
          break
        case 500:
          console.error('服务器内部错误')
          break
        default:
          console.error('请求失败:', data?.message || '未知错误')
      }
    } else if (error.request) {
      console.error('网络错误，请检查网络连接')
    }
    
    return Promise.reject(error)
  }
)

export default api
```

#### 3. 更新 `vite.config.ts`

```typescript
import { defineConfig, loadEnv } from 'vite'
import vue from '@vitejs/plugin-vue'
import { fileURLToPath, URL } from 'node:url'

export default defineConfig(({ mode }) => {
  // 加载环境变量
  const env = loadEnv(mode, process.cwd(), '')
  
  return {
    plugins: [vue()],
    resolve: {
      alias: {
        '@': fileURLToPath(new URL('./src', import.meta.url))
      }
    },
    server: {
      port: 3000,
      host: '0.0.0.0',
      // 只在开发环境且没有设置API地址时使用代理
      proxy: !env.VITE_API_BASE_URL ? {
        '/api': {
          target: 'http://localhost:8081', // 模拟后端地址
          changeOrigin: true,
          secure: false,
          ws: true
        }
      } : undefined
    }
  }
})
```

## 🎯 不同场景的配置

### 场景1：本地开发，使用模拟后端

**`.env.development`**：
```env
# 不设置VITE_API_BASE_URL，使用Vite代理到模拟后端
VITE_APP_TITLE=TestPro开发环境
```

**启动命令**：
```bash
npm run dev:full  # 同时启动前端和模拟后端
```

### 场景2：本地开发，连接真实后端

**`.env.development`**：
```env
VITE_API_BASE_URL=http://192.168.1.100:8080/api
VITE_APP_TITLE=TestPro开发环境
```

**启动命令**：
```bash
npm run dev  # 只启动前端
```

### 场景3：连接测试环境

**`.env.test`**：
```env
VITE_API_BASE_URL=https://test-api.testpro.com/api
VITE_APP_TITLE=TestPro测试环境
```

**启动命令**：
```bash
npm run dev --mode test
```

### 场景4：生产环境

**`.env.production`**：
```env
VITE_API_BASE_URL=https://api.testpro.com/api
VITE_APP_TITLE=TestPro
```

**构建命令**：
```bash
npm run build
```

## 🔄 快速切换环境

### 方法1：使用不同的启动命令

在 `package.json` 中添加脚本：
```json
{
  "scripts": {
    "dev": "vite",
    "dev:mock": "run-p dev mock",
    "dev:test": "vite --mode test",
    "dev:prod": "vite --mode production",
    "build": "vue-tsc && vite build",
    "build:test": "vue-tsc && vite build --mode test"
  }
}
```

### 方法2：创建配置切换脚本

创建 `scripts/switch-env.js`：
```javascript
const fs = require('fs')
const path = require('path')

const envConfigs = {
  mock: `# 模拟后端
VITE_APP_TITLE=TestPro开发环境`,
  
  dev: `# 开发后端
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=TestPro开发环境`,
  
  test: `# 测试环境
VITE_API_BASE_URL=https://test-api.testpro.com/api
VITE_APP_TITLE=TestPro测试环境`,
  
  prod: `# 生产环境
VITE_API_BASE_URL=https://api.testpro.com/api
VITE_APP_TITLE=TestPro`
}

const env = process.argv[2]
if (!env || !envConfigs[env]) {
  console.log('使用方法: node scripts/switch-env.js [mock|dev|test|prod]')
  process.exit(1)
}

fs.writeFileSync('.env.development', envConfigs[env])
console.log(`已切换到 ${env} 环境`)
```

使用方法：
```bash
node scripts/switch-env.js mock  # 切换到模拟后端
node scripts/switch-env.js dev   # 切换到开发后端
node scripts/switch-env.js test  # 切换到测试环境
```

## 🧪 测试配置

### 1. 检查当前配置

在浏览器控制台中运行：
```javascript
console.log('当前API地址:', import.meta.env.VITE_API_BASE_URL)
console.log('当前环境:', import.meta.env.MODE)
console.log('是否开发环境:', import.meta.env.DEV)
```

### 2. 测试API连接

创建一个测试页面或在现有页面中添加：
```typescript
// 测试API连接
const testConnection = async () => {
  try {
    const response = await fetch(import.meta.env.VITE_API_BASE_URL + '/health')
    console.log('API连接正常:', response.status)
  } catch (error) {
    console.error('API连接失败:', error)
  }
}
```

## 📝 注意事项

### 1. 环境变量命名
- 必须以 `VITE_` 开头才能在前端代码中访问
- 不要在环境变量中存储敏感信息

### 2. 文件安全
- 将 `.env.local` 添加到 `.gitignore`
- 不要提交包含敏感信息的环境变量文件

### 3. 跨域处理
- 开发环境可以使用代理
- 生产环境需要后端配置CORS

### 4. 缓存问题
- 修改环境变量后需要重启开发服务器
- 浏览器可能缓存旧的配置，需要硬刷新

---

**💡 提示：建议先在开发环境测试配置，确认无误后再应用到生产环境。**
